version: '3'

services:

    proxy:
      image: traefik:2.0
      volumes:
        - ./:/var/www
        - /var/run/docker.sock:/var/run/docker.sock
        - ./.docker/config/traefik:/etc/traefik
      ports:
        - "80:80"
        - "443:443"
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api_http.rule=Host(`proxy.local`)"
        - "traefik.http.routers.api_http.middlewares=secure@file"
        - "traefik.http.routers.api.rule=Host(`proxy.local`)"
        - "traefik.http.routers.api.service=api@internal"
        - "traefik.http.routers.api.tls=true"

    app:
      image: rpopuc/php-fpm-nginx:7.4
      volumes:
        - ./:/var/www
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.app_http.rule=Host(`register.local`)"
        - "traefik.http.routers.app_http.middlewares=secure@file"
        - "traefik.http.routers.app.rule=Host(`register.local`)"
        - "traefik.http.routers.app.tls=true"
      ports:
        - 8080:80

    postgres:
      image: postgres:13
      volumes:
        - ./.docker/data/postgres:/var/lib/postgresql/data
        - ./:/var/www
      environment:
        - POSTGRES_DB=app
        - POSTGRES_USER=app
        - POSTGRES_PASSWORD=app

    # redis:
    #   image: rpopuc/redis:4-alpine
    #   volumes:
    #     - ./.docker/data/redis:/data

    # worker:
    #   image: rpopuc/php-worker:7.3
    #   depends_on:
    #     - postgres
    #   volumes:
    #     - ./:/var/www
    #     - ~/.ssh:/home/laradock/.ssh
